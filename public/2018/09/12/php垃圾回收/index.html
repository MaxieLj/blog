<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>php垃圾回收 | Maxie'blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">php垃圾回收</h1><a id="logo" href="/.">Maxie'blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">php垃圾回收</h1><div class="post-meta">Sep 12, 2018<span> | </span><span class="category"><a href="/categories/php源码学习/">php源码学习</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#内存使用的优化"><span class="toc-number">1.</span> <span class="toc-text">内存使用的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引用计数"><span class="toc-number">1.1.</span> <span class="toc-text">引用计数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#写时复制"><span class="toc-number">1.2.</span> <span class="toc-text">写时复制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存回收"><span class="toc-number">2.</span> <span class="toc-text">内存回收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自动gc"><span class="toc-number">2.1.</span> <span class="toc-text">自动gc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#辣鸡回收"><span class="toc-number">2.2.</span> <span class="toc-text">辣鸡回收</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回收机制"><span class="toc-number">2.3.</span> <span class="toc-text">回收机制</span></a></li></ol></li></ol></div></div><div class="post-content"><p>php是如何实现内存管理的?内存管理无非包括内存分配、内存回收、以及内存使用优化。</p>
<ul>
<li>内存使用的优化</li>
<li>垃圾回收机制</li>
<li>底层内存分配</li>
</ul>
<h2 id="内存使用的优化"><a href="#内存使用的优化" class="headerlink" title="内存使用的优化"></a>内存使用的优化</h2><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>php的引用中有个引用结构体</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">```c</div><div class="line">struct _zend_reference &#123;</div><div class="line">    zend_refcondted_h gc;</div><div class="line">    zval              val;  指向原来的value.</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">其中`zend_refcondted_h` 便是gc便是当前变量被引用的次数,这个参数会在变量回收的时候用到。</div><div class="line"></div><div class="line"></div><div class="line">zend_refcondted_h :</div><div class="line"></div><div class="line">```c</div><div class="line">typedef struct _zend_refcounted_h &#123;</div><div class="line">	uint32_t         refcount;			/* reference counter 32-bit */</div><div class="line">	union &#123;</div><div class="line">		struct &#123;</div><div class="line">			ZEND_ENDIAN_LOHI_3(</div><div class="line">				zend_uchar    type,</div><div class="line">				zend_uchar    flags,    /* used for strings &amp; objects */</div><div class="line">				uint16_t      gc_info)  /* keeps GC root number (or 0) and color */</div><div class="line">		&#125; v;</div><div class="line">		uint32_t type_info;</div><div class="line">	&#125; u;</div><div class="line">&#125; zend_refcounted_h;</div></pre></td></tr></table></figure>
<p>在实际中这个结构体到底是什么样的? 具体可以举例来看。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$a = <span class="string">'this is string'</span>; <span class="comment">// zend_array (refcount = 1)  只有$a引用了zend_array</span></div><div class="line">$b = &amp;$a; <span class="comment">//   zend_array (refcount = 2)  $a、$b引用了zend_array</span></div><div class="line">$c = $b; <span class="comment">// zend_array (refcount = 3)  $a、$b、$c引用了zend_array</span></div><div class="line"><span class="keyword">unset</span>($b); <span class="comment">// zend_array (refcount = 2)  $a、$c引用了zend_array</span></div></pre></td></tr></table></figure>
<blockquote>
<p>并不是所有的变量类型都会使用引用计数, 例如 <code>整形</code>、<code>浮点型</code>、<code>布尔型</code>、<code>NUll</code>(在php中这是一个变量类型)等采用了深拷贝,<br>即只要这几种变量赋值, 就会申请一款一块内存写入一个新的变量结构（注意这里不是引用结构）,当然这些类型不会公用value。</p>
</blockquote>
<h3 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h3><p>当然只有引用计数是不够的, 因为变量会发生赋值的情况。所以在更改某一个变量时, 会对原来的变量进行拷贝并赋值。</p>
<p>举个栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$foo = time();</div><div class="line">$bar = &amp;$b;</div><div class="line">$si = $a;</div><div class="line"></div><div class="line">$c = &apos;123&apos;;</div></pre></td></tr></table></figure>
<p>具体数据结构的引用计数情况如下图:</p>
<p><img src="/photo/img/php内存管理/写时复制.png" alt="image"></p>
<h2 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h2><h3 id="自动gc"><a href="#自动gc" class="headerlink" title="自动gc"></a>自动gc</h3><p>在zend数据接口中有一个gc.refount,他是自动gc的关键。</p>
<p>在自动gc机制中,如果zval不在指向value且当前value的gc.refount为0时,会直接释放value。这种情况多发生于函数返回时（销毁所有局部变量）、变量修改时、以及unset操作的时候。</p>
<h3 id="辣鸡回收"><a href="#辣鸡回收" class="headerlink" title="辣鸡回收"></a>辣鸡回收</h3><p>除了自动gc,还有一种是自动gc无法处理的垃圾, 这种情况称为<code>循环引用</code>。顾名思义也就是自身内部变量引用了自身, 这种情况常出现与object和array。当我该变量zval被销毁是, 与其对应的value gc.refcount -1,<br>但是因为有自身变量指向自身, 所以就陷入了一个循环:如果不销毁自身变量 value gc.refcount就无法自动gc, 只有自动gc才会销毁value。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$a = [<span class="number">1</span>];</div><div class="line">$a[] = &amp;$a;</div><div class="line"><span class="keyword">unset</span>($a);</div></pre></td></tr></table></figure>
<p><img src="/photo/img/php内存管理/自身引用.png" alt="image"></p>
<p><code>unset($a)</code>执行以后</p>
<p><img src="/photo/img/php内存管理/释放.png" alt="image"></p>
<p>由于上述情况导致无法自动gc,所以需要引入另外一钟垃圾回收机制-垃圾回收器。<br>现在会存在两种情况的数据需要回收：</p>
<ul>
<li>当value的gc.refcount =0 是需要回收。</li>
<li>当value的gc.refcount 减少不等于0，但是存在循环引用时。</li>
</ul>
<h3 id="回收机制"><a href="#回收机制" class="headerlink" title="回收机制"></a>回收机制</h3><p>当发生value gc.refcount减少时，垃圾回收机制会把可能是垃圾的value存起来， 当可能是辣鸡的value到达一定数量的时候启动垃圾鉴别程序，统一处理垃圾。当然这里的value类型只有object和array。</p>
<p>垃圾兼备程序：<br>其实垃圾鉴别程序很简单，递归遍历自身value，查看是否存在指向自身的即可。</p>
<p>code:<br>gc 初始化<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ZEND_API void gc_init(void)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (GC_G(buf) == <span class="keyword">NULL</span> &amp;&amp; GC_G(gc_enabled)) &#123;</div><div class="line">		<span class="comment">//初始化buf内存区域，大小为sizeof(gc_root_buffer) * //GC_ROOT_BUFFER_MAX_ENTRIES</span></div><div class="line">		GC_G(buf) = (gc_root_buffer*) malloc(sizeof(gc_root_buffer) * GC_ROOT_BUFFER_MAX_ENTRIES);</div><div class="line">		<span class="comment">//设置_zend_gc_globals.last_unused为bug入口位置</span></div><div class="line">		GC_G(last_unused) = &amp;GC_G(buf)[GC_ROOT_BUFFER_MAX_ENTRIES];</div><div class="line">		<span class="comment">//初始化_zend_gc_globals的参数</span></div><div class="line">		gc_reset();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>垃圾回收及其依赖 <code>_zend_gc_globals</code></p>
<p><code>_zend_gc_globals</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _zend_gc_globals &#123;</div><div class="line">	zend_bool         gc_enabled;</div><div class="line">	zend_bool         gc_active;</div><div class="line">	zend_bool         gc_full;</div><div class="line"></div><div class="line">	gc_root_buffer   *buf;				<span class="comment">/* preallocated arrays of buffers   */</span></div><div class="line">	gc_root_buffer    roots;			<span class="comment">/* list of possible roots of cycles */</span></div><div class="line">	gc_root_buffer   *unused;			<span class="comment">/* list of unused buffers           */</span></div><div class="line">	gc_root_buffer   *first_unused;		<span class="comment">/* pointer to first unused buffer   */</span></div><div class="line">	gc_root_buffer   *last_unused;		<span class="comment">/* pointer to last unused buffer    */</span></div><div class="line"></div><div class="line">	gc_root_buffer    to_free;			<span class="comment">/* list to free                     */</span></div><div class="line">	gc_root_buffer   *next_to_free;</div><div class="line"></div><div class="line">	<span class="keyword">uint32_t</span> gc_runs;</div><div class="line">	<span class="keyword">uint32_t</span> collected;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> GC_BENCH</span></div><div class="line">	<span class="keyword">uint32_t</span> root_buf_length;</div><div class="line">	<span class="keyword">uint32_t</span> root_buf_peak;</div><div class="line">	<span class="keyword">uint32_t</span> zval_possible_root;</div><div class="line">	<span class="keyword">uint32_t</span> zval_buffered;</div><div class="line">	<span class="keyword">uint32_t</span> zval_remove_from_buffer;</div><div class="line">	<span class="keyword">uint32_t</span> zval_marked_grey;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">	gc_additional_buffer *additional_buffer;</div><div class="line"></div><div class="line">&#125; zend_gc_globals;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>gc_enabled</code> 是否使使用gc</li>
<li><code>gc_active</code>  是否在垃圾检查的过程中</li>
<li><code>gc_full</code> buf缓冲区是否已满</li>
<li><code>*buf</code> 与分配用于保存可能为垃圾的value</li>
<li><code>roots</code> 指向buf最新加入的一个可能垃圾</li>
<li><code>unused</code> 指向第未使用的buffer</li>
<li><code>*first_unused</code> 指向第一个没用使用buffer</li>
<li><code>*last_unused</code> 指向buffer的尾部</li>
<li><code>to_free</code> 等待释放的buffer</li>
<li><code>gc_runs</code>  统计gc运行的次数</li>
<li><code>collected</code>  统计已经释放的垃圾数</li>
</ul>
<p>php垃圾回收中几个重要的颜色写在zeng_gc的备注中。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">* BLACK  (GC_BLACK)   - In use or <span class="built_in">free</span>.</div><div class="line">* GREY   (GC_GREY)    - Possible member of cycle.</div><div class="line">* WHITE  (GC_WHITE)   - Member of garbage cycle.</div><div class="line">* PURPLE (GC_PURPLE)  - Possible root of cycle.</div></pre></td></tr></table></figure></p>
<ul>
<li>GC_WHITE 白色表示垃圾</li>
<li>GC_PURPLE 紫色表示已放入缓冲区</li>
<li>GC_GREY 灰色表示已经进行了一次refcount的减一操作</li>
<li>GC_BLACK 黑色是默认颜色，正常</li>
</ul>
<p>gc过程中主要处理功能的函数<code>zend_gc_collect_cycles</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function">ZEND_API <span class="keyword">void</span> ZEND_FASTCALL <span class="title">gc_possible_root</span><span class="params">(zend_refcounted *ref)</span></span></div><div class="line">&#123;</div><div class="line">	gc_root_buffer *newRoot;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (UNEXPECTED(CG(unclean_shutdown)) || UNEXPECTED(GC_G(gc_active))) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	ZEND_ASSERT(GC_TYPE(ref) == IS_ARRAY || GC_TYPE(ref) == IS_OBJECT);</div><div class="line">	ZEND_ASSERT(EXPECTED(GC_REF_GET_COLOR(ref) == GC_BLACK));</div><div class="line">	ZEND_ASSERT(!GC_ADDRESS(GC_INFO(ref)));</div><div class="line"></div><div class="line">	GC_BENCH_INC(zval_possible_root);</div><div class="line"></div><div class="line">	newRoot = GC_G(unused);</div><div class="line">	<span class="keyword">if</span> (newRoot) &#123;</div><div class="line">		GC_G(unused) = newRoot-&gt;prev;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_G(first_unused) != GC_G(last_unused)) &#123;</div><div class="line">		newRoot = GC_G(first_unused);</div><div class="line">		GC_G(first_unused)++;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//垃圾处理，当缓冲区满时，程序调用gc_collect_cycles函数，执行垃圾回收操作。 其中最关键的几步就是</span></div><div class="line">		<span class="comment">//如果当前处于可以gc的状态</span></div><div class="line">		<span class="keyword">if</span> (!GC_G(gc_enabled)) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		GC_REFCOUNT(ref)++;</div><div class="line">		<span class="comment">//垃圾回收</span></div><div class="line">		gc_collect_cycles();</div><div class="line">		GC_REFCOUNT(ref)--;</div><div class="line">		<span class="keyword">if</span> (UNEXPECTED(GC_REFCOUNT(ref)) == <span class="number">0</span>) &#123;</div><div class="line">			zval_dtor_func(ref);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (UNEXPECTED(GC_INFO(ref))) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		newRoot = GC_G(unused);</div><div class="line">		<span class="keyword">if</span> (!newRoot) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		GC_G(unused) = newRoot-&gt;prev;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	GC_TRACE_SET_COLOR(ref, GC_PURPLE);</div><div class="line">	GC_INFO(ref) = (newRoot - GC_G(buf)) | GC_PURPLE;</div><div class="line">	newRoot-&gt;ref = ref;</div><div class="line"></div><div class="line">	newRoot-&gt;next = GC_G(roots).next;</div><div class="line">	newRoot-&gt;prev = &amp;GC_G(roots);</div><div class="line">	GC_G(roots).next-&gt;prev = newRoot;</div><div class="line">	GC_G(roots).next = newRoot;</div><div class="line"></div><div class="line">	GC_BENCH_INC(zval_buffered);</div><div class="line">	GC_BENCH_INC(root_buf_length);</div><div class="line">	GC_BENCH_PEAK(root_buf_peak, root_buf_length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>debug代码已删除</p>
<ol>
<li>深度优先对对象或者数据的每一个元素的<code>refcount--</code>并将其标记为灰色</li>
<li>深度遍历root的每个每个变量，如果此时变量的<code>refcount</code>为0，则代表着改变量为垃圾，将其标记为垃圾，如果不为0，则将其标记为黑色（正常）。</li>
<li>检查roots清除标记为白色的垃圾。</li>
</ol>
<p>//TODO 垃圾回收抽出来出来写。</p>
<p>具体代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">ZEND_API int zend_gc_collect_cycles(void)</div><div class="line">&#123;</div><div class="line">	int count = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (GC_G(roots).next != &amp;GC_G(roots)) &#123;</div><div class="line">		gc_root_buffer *current, *next, *orig_next_to_free;</div><div class="line">		zend_refcounted *p;</div><div class="line">		gc_root_buffer to_free;</div><div class="line">		uint32_t gc_flags = <span class="number">0</span>;</div><div class="line">		gc_additional_buffer *additional_buffer_snapshot;</div><div class="line"></div><div class="line"></div><div class="line">		<span class="keyword">if</span> (GC_G(gc_active)) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		GC_TRACE(<span class="string">"Collecting cycles"</span>);</div><div class="line">		<span class="comment">//标识gc运行了多少次</span></div><div class="line">		GC_G(gc_runs)++;</div><div class="line">		<span class="comment">//标识当前正在gc</span></div><div class="line">		GC_G(gc_active) = <span class="number">1</span>;</div><div class="line"></div><div class="line">		GC_TRACE(<span class="string">"Marking roots"</span>);</div><div class="line">		<span class="comment">//重点</span></div><div class="line">		gc_mark_roots();</div><div class="line">		GC_TRACE(<span class="string">"Scanning roots"</span>);</div><div class="line">		<span class="comment">//重点</span></div><div class="line">		gc_scan_roots();</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">		GC_TRACE(<span class="string">"Collecting roots"</span>);</div><div class="line">		additional_buffer_snapshot = GC_G(additional_buffer);</div><div class="line">		count = gc_collect_roots(&amp;gc_flags);</div><div class="line"></div><div class="line">		GC_G(gc_active) = <span class="number">0</span>;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (GC_G(to_free).next == &amp;GC_G(to_free)) &#123;</div><div class="line">			<span class="comment">/* nothing to free */</span></div><div class="line">			GC_TRACE(<span class="string">"Nothing to free"</span>);</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* Copy global to_free list into local list */</span></div><div class="line">		to_free.next = GC_G(to_free).next;</div><div class="line">		to_free.prev = GC_G(to_free).prev;</div><div class="line">		to_free.next-&gt;prev = &amp;to_free;</div><div class="line">		to_free.prev-&gt;next = &amp;to_free;</div><div class="line"></div><div class="line">		<span class="comment">/* Free global list */</span></div><div class="line">		GC_G(to_free).next = &amp;GC_G(to_free);</div><div class="line">		GC_G(to_free).prev = &amp;GC_G(to_free);</div><div class="line"></div><div class="line">		orig_next_to_free = GC_G(next_to_free);</div><div class="line"></div><div class="line"></div><div class="line">		<span class="keyword">if</span> (gc_flags &amp; GC_HAS_DESTRUCTORS) &#123;</div><div class="line">			GC_TRACE(<span class="string">"Calling destructors"</span>);</div><div class="line"></div><div class="line">			<span class="comment">/* Remember reference counters before calling destructors */</span></div><div class="line">			current = to_free.next;</div><div class="line">			<span class="keyword">while</span> (current != &amp;to_free) &#123;</div><div class="line">				current-&gt;refcount = GC_REFCOUNT(current-&gt;ref);</div><div class="line">				current = current-&gt;next;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">/* Call destructors */</span></div><div class="line">			current = to_free.next;</div><div class="line">			<span class="keyword">while</span> (current != &amp;to_free) &#123;</div><div class="line">				p = current-&gt;ref;</div><div class="line">				GC_G(next_to_free) = current-&gt;next;</div><div class="line">				<span class="keyword">if</span> (GC_TYPE(p) == IS_OBJECT) &#123;</div><div class="line">					zend_object *obj = (zend_object*)p;</div><div class="line"></div><div class="line">					<span class="keyword">if</span> (!(GC_FLAGS(obj) &amp; IS_OBJ_DESTRUCTOR_CALLED)) &#123;</div><div class="line">						GC_TRACE_REF(obj, <span class="string">"calling destructor"</span>);</div><div class="line">						GC_FLAGS(obj) |= IS_OBJ_DESTRUCTOR_CALLED;</div><div class="line">						<span class="keyword">if</span> (obj-&gt;handlers-&gt;dtor_obj</div><div class="line">						 &amp;&amp; (obj-&gt;handlers-&gt;dtor_obj != zend_objects_destroy_object</div><div class="line">						  || obj-&gt;ce-&gt;destructor)) &#123;</div><div class="line">							GC_REFCOUNT(obj)++;</div><div class="line">							obj-&gt;handlers-&gt;dtor_obj(obj);</div><div class="line">							GC_REFCOUNT(obj)--;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				current = GC_G(next_to_free);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">/* Remove values captured in destructors */</span></div><div class="line">			current = to_free.next;</div><div class="line">			<span class="keyword">while</span> (current != &amp;to_free) &#123;</div><div class="line">				GC_G(next_to_free) = current-&gt;next;</div><div class="line">				<span class="keyword">if</span> (GC_REFCOUNT(current-&gt;ref) &gt; current-&gt;refcount) &#123;</div><div class="line">					gc_remove_nested_data_from_buffer(current-&gt;ref, current);</div><div class="line">				&#125;</div><div class="line">				current = GC_G(next_to_free);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* Destroy zvals */</span></div><div class="line">		GC_TRACE(<span class="string">"Destroying zvals"</span>);</div><div class="line">		GC_G(gc_active) = <span class="number">1</span>;</div><div class="line">		current = to_free.next;</div><div class="line">		<span class="keyword">while</span> (current != &amp;to_free) &#123;</div><div class="line">			p = current-&gt;ref;</div><div class="line">			GC_G(next_to_free) = current-&gt;next;</div><div class="line">			GC_TRACE_REF(p, <span class="string">"destroying"</span>);</div><div class="line">			<span class="keyword">if</span> (GC_TYPE(p) == IS_OBJECT) &#123;</div><div class="line">				zend_object *obj = (zend_object*)p;</div><div class="line"></div><div class="line">				EG(objects_store).object_buckets[obj-&gt;handle] = SET_OBJ_INVALID(obj);</div><div class="line">				GC_TYPE(obj) = IS_NULL;</div><div class="line">				<span class="keyword">if</span> (!(GC_FLAGS(obj) &amp; IS_OBJ_FREE_CALLED)) &#123;</div><div class="line">					GC_FLAGS(obj) |= IS_OBJ_FREE_CALLED;</div><div class="line">					<span class="keyword">if</span> (obj-&gt;handlers-&gt;free_obj) &#123;</div><div class="line">						GC_REFCOUNT(obj)++;</div><div class="line">						obj-&gt;handlers-&gt;free_obj(obj);</div><div class="line">						GC_REFCOUNT(obj)--;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				SET_OBJ_BUCKET_NUMBER(EG(objects_store).object_buckets[obj-&gt;handle], EG(objects_store).free_list_head);</div><div class="line">				EG(objects_store).free_list_head = obj-&gt;handle;</div><div class="line">				p = current-&gt;ref = (zend_refcounted*)(((char*)obj) - obj-&gt;handlers-&gt;offset);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_TYPE(p) == IS_ARRAY) &#123;</div><div class="line">				zend_array *arr = (zend_array*)p;</div><div class="line"></div><div class="line">				GC_TYPE(arr) = IS_NULL;</div><div class="line"></div><div class="line">				<span class="comment">/* GC may destroy arrays with rc&gt;1. This is valid and safe. */</span></div><div class="line">				HT_ALLOW_COW_VIOLATION(arr);</div><div class="line"></div><div class="line">				zend_hash_destroy(arr);</div><div class="line">			&#125;</div><div class="line">			current = GC_G(next_to_free);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/* Free objects */</span></div><div class="line">		current = to_free.next;</div><div class="line">		<span class="keyword">while</span> (current != &amp;to_free) &#123;</div><div class="line">			next = current-&gt;next;</div><div class="line">			p = current-&gt;ref;</div><div class="line">			<span class="keyword">if</span> (EXPECTED(current &gt;= GC_G(buf) &amp;&amp; current &lt; GC_G(buf) + GC_ROOT_BUFFER_MAX_ENTRIES)) &#123;</div><div class="line">				current-&gt;prev = GC_G(unused);</div><div class="line">				GC_G(unused) = current;</div><div class="line">			&#125;</div><div class="line">			efree(p);</div><div class="line">			current = next;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">while</span> (GC_G(additional_buffer) != additional_buffer_snapshot) &#123;</div><div class="line">			gc_additional_buffer *next = GC_G(additional_buffer)-&gt;next;</div><div class="line">			efree(GC_G(additional_buffer));</div><div class="line">			GC_G(additional_buffer) = next;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		GC_TRACE(<span class="string">"Collection finished"</span>);</div><div class="line">		GC_G(collected) += count;</div><div class="line">		GC_G(next_to_free) = orig_next_to_free;</div><div class="line">		GC_G(gc_active) = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> count;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gc_mark_roots</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	gc_root_buffer *current = GC_G(roots).next;</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (current != &amp;GC_G(roots)) &#123;</div><div class="line">		<span class="comment">//GC_PURPLE 标识在缓冲区</span></div><div class="line">		<span class="keyword">if</span> (GC_REF_GET_COLOR(current-&gt;ref) == GC_PURPLE) &#123;</div><div class="line">			gc_mark_grey(current-&gt;ref);</div><div class="line">		&#125;</div><div class="line">		current = current-&gt;next;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gc_mark_grey</span><span class="params">(zend_refcounted *ref)</span></span></div><div class="line">&#123;</div><div class="line">    HashTable *ht;</div><div class="line">	Bucket *p, *end;</div><div class="line">	zval *zv;</div><div class="line"></div><div class="line">tail_call:</div><div class="line">	<span class="keyword">if</span> (GC_REF_GET_COLOR(ref) != GC_GREY) &#123;</div><div class="line">		ht = <span class="literal">NULL</span>;</div><div class="line">		GC_BENCH_INC(zval_marked_grey);</div><div class="line">		GC_REF_SET_COLOR(ref, GC_GREY);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (GC_TYPE(ref) == IS_OBJECT) &#123;</div><div class="line">			<span class="keyword">zend_object_get_gc_t</span> get_gc;</div><div class="line">			zend_object *obj = (zend_object*)ref;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (EXPECTED(!(GC_FLAGS(ref) &amp; IS_OBJ_FREE_CALLED) &amp;&amp;</div><div class="line">		                 (get_gc = obj-&gt;handlers-&gt;get_gc) != <span class="literal">NULL</span>)) &#123;</div><div class="line">				<span class="keyword">int</span> n;</div><div class="line">				zval *zv, *end;</div><div class="line">				zval tmp;</div><div class="line"></div><div class="line">				ZVAL_OBJ(&amp;tmp, obj);</div><div class="line">				ht = get_gc(&amp;tmp, &amp;zv, &amp;n);</div><div class="line">				end = zv + n;</div><div class="line">				<span class="keyword">if</span> (EXPECTED(!ht)) &#123;</div><div class="line">					<span class="keyword">if</span> (!n) <span class="keyword">return</span>;</div><div class="line">					<span class="keyword">while</span> (!Z_REFCOUNTED_P(--end)) &#123;</div><div class="line">						<span class="comment">//表明当前object size为0</span></div><div class="line">						<span class="keyword">if</span> (zv == end) <span class="keyword">return</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">while</span> (zv != end) &#123;</div><div class="line">					<span class="comment">//循环对每个元素进行--</span></div><div class="line">					<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">						ref = Z_COUNTED_P(zv);</div><div class="line">						GC_REFCOUNT(ref)--;</div><div class="line">						<span class="comment">//refcount已经减过，标记为灰色</span></div><div class="line">						gc_mark_grey(ref);</div><div class="line">					&#125;</div><div class="line">					zv++;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (EXPECTED(!ht)) &#123;</div><div class="line">					ref = Z_COUNTED_P(zv);</div><div class="line">					GC_REFCOUNT(ref)--;</div><div class="line">					<span class="keyword">goto</span> tail_call;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_TYPE(ref) == IS_ARRAY) &#123;</div><div class="line">			<span class="keyword">if</span> (((zend_array*)ref) == &amp;EG(symbol_table)) &#123;</div><div class="line">				<span class="comment">//标识是正常非垃圾</span></div><div class="line">				GC_REF_SET_BLACK(ref);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				ht = (zend_array*)ref;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_TYPE(ref) == IS_REFERENCE) &#123;</div><div class="line">			<span class="keyword">if</span> (Z_REFCOUNTED(((zend_reference*)ref)-&gt;val)) &#123;</div><div class="line">				ref = Z_COUNTED(((zend_reference*)ref)-&gt;val);</div><div class="line">				GC_REFCOUNT(ref)--;</div><div class="line">				<span class="keyword">goto</span> tail_call;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!ht-&gt;nNumUsed) <span class="keyword">return</span>;</div><div class="line">		p = ht-&gt;arData;</div><div class="line">		end = p + ht-&gt;nNumUsed;</div><div class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">			end--;</div><div class="line">			zv = &amp;end-&gt;val;</div><div class="line">			<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">				zv = Z_INDIRECT_P(zv);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (p == end) <span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">while</span> (p != end) &#123;</div><div class="line">			zv = &amp;p-&gt;val;</div><div class="line">			<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">				zv = Z_INDIRECT_P(zv);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">				ref = Z_COUNTED_P(zv);</div><div class="line">				GC_REFCOUNT(ref)--;</div><div class="line">				gc_mark_grey(ref);</div><div class="line">			&#125;</div><div class="line">			p++;</div><div class="line">		&#125;</div><div class="line">		zv = &amp;p-&gt;val;</div><div class="line">		<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">			zv = Z_INDIRECT_P(zv);</div><div class="line">		&#125;</div><div class="line">		ref = Z_COUNTED_P(zv);</div><div class="line">		GC_REFCOUNT(ref)--;</div><div class="line">		<span class="keyword">goto</span> tail_call;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gc_scan</span><span class="params">(zend_refcounted *ref)</span></span></div><div class="line">&#123;</div><div class="line">    HashTable *ht;</div><div class="line">	Bucket *p, *end;</div><div class="line">	zval *zv;</div><div class="line"></div><div class="line">tail_call:</div><div class="line">	<span class="keyword">if</span> (GC_REF_GET_COLOR(ref) == GC_GREY) &#123;</div><div class="line">		<span class="keyword">if</span> (GC_REFCOUNT(ref) &gt; <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">//所有refount--以后如果还&gt;0，说明非垃圾</span></div><div class="line">			gc_scan_black(ref);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//否则则为垃圾</span></div><div class="line">			GC_REF_SET_COLOR(ref, GC_WHITE);</div><div class="line">			<span class="keyword">if</span> (GC_TYPE(ref) == IS_OBJECT) &#123;</div><div class="line">				<span class="keyword">zend_object_get_gc_t</span> get_gc;</div><div class="line">				zend_object *obj = (zend_object*)ref;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (EXPECTED(!(GC_FLAGS(ref) &amp; IS_OBJ_FREE_CALLED) &amp;&amp;</div><div class="line">				             (get_gc = obj-&gt;handlers-&gt;get_gc) != <span class="literal">NULL</span>)) &#123;</div><div class="line">					<span class="keyword">int</span> n;</div><div class="line">					zval *zv, *end;</div><div class="line">					zval tmp;</div><div class="line"></div><div class="line">					ZVAL_OBJ(&amp;tmp, obj);</div><div class="line">					ht = get_gc(&amp;tmp, &amp;zv, &amp;n);</div><div class="line">					end = zv + n;</div><div class="line">					<span class="keyword">if</span> (EXPECTED(!ht)) &#123;</div><div class="line">						<span class="keyword">if</span> (!n) <span class="keyword">return</span>;</div><div class="line">						<span class="keyword">while</span> (!Z_REFCOUNTED_P(--end)) &#123;</div><div class="line">							<span class="keyword">if</span> (zv == end) <span class="keyword">return</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">while</span> (zv != end) &#123;</div><div class="line">						<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">							ref = Z_COUNTED_P(zv);</div><div class="line">							gc_scan(ref);</div><div class="line">						&#125;</div><div class="line">						zv++;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span> (EXPECTED(!ht)) &#123;</div><div class="line">						ref = Z_COUNTED_P(zv);</div><div class="line">						<span class="keyword">goto</span> tail_call;</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_TYPE(ref) == IS_ARRAY) &#123;</div><div class="line">				<span class="keyword">if</span> ((zend_array*)ref == &amp;EG(symbol_table)) &#123;</div><div class="line">					GC_REF_SET_BLACK(ref);</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ht = (zend_array*)ref;</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (GC_TYPE(ref) == IS_REFERENCE) &#123;</div><div class="line">				<span class="keyword">if</span> (Z_REFCOUNTED(((zend_reference*)ref)-&gt;val)) &#123;</div><div class="line">					ref = Z_COUNTED(((zend_reference*)ref)-&gt;val);</div><div class="line">					<span class="keyword">goto</span> tail_call;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (!ht-&gt;nNumUsed) <span class="keyword">return</span>;</div><div class="line">			p = ht-&gt;arData;</div><div class="line">			end = p + ht-&gt;nNumUsed;</div><div class="line">			<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">				end--;</div><div class="line">				zv = &amp;end-&gt;val;</div><div class="line">				<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">					zv = Z_INDIRECT_P(zv);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (p == end) <span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">while</span> (p != end) &#123;</div><div class="line">				zv = &amp;p-&gt;val;</div><div class="line">				<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">					zv = Z_INDIRECT_P(zv);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (Z_REFCOUNTED_P(zv)) &#123;</div><div class="line">					ref = Z_COUNTED_P(zv);</div><div class="line">					gc_scan(ref);</div><div class="line">				&#125;</div><div class="line">				p++;</div><div class="line">			&#125;</div><div class="line">			zv = &amp;p-&gt;val;</div><div class="line">			<span class="keyword">if</span> (Z_TYPE_P(zv) == IS_INDIRECT) &#123;</div><div class="line">				zv = Z_INDIRECT_P(zv);</div><div class="line">			&#125;</div><div class="line">			ref = Z_COUNTED_P(zv);</div><div class="line">			<span class="keyword">goto</span> tail_call;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要为三个函数：</p>
<ul>
<li><code>gc_mark_roots</code>队规遍历，对object、array所有元素的refcount–并将其标记为灰色</li>
<li><code>gc_scan_roots</code>这个函数对节点信息的链表再次进行深度优先遍历，如果发现zval的refcount大于等于1，则对该zval和其包含的zval的refcount加1操作，这个是对非垃圾的一个信息还原，然后将这些zval颜色属性去掉(设置成black)。如果发现zval的refcount等于0，则就标记成白色，这些是后面将要清理掉的垃圾。</li>
<li><code>gc_collect_roots</code> 遍历节点信息链表,将前面一个步骤中标记为白色的节点信息放到GC_G(zval_to_free)为入口的链表中，这个链表用来存放将要释放的垃圾。 然后释放掉全部的节点信息，缓冲区被清空。分析结束后将重新收集节点信息。</li>
</ul>
</div><div class="tags"><a href="/tags/php源码/">php源码</a></div><div class="post-nav"><a class="pre" href="/2018/09/12/微服务数据一致性和服务可靠性/">微服务数据一致性和服务可靠性</a><a class="next" href="/2018/08/25/php闭包/">php闭包</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/c语言/">c语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kong/">kong</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php源码学习/">php源码学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/折腾/">折腾</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/solr/" style="font-size: 15px;">solr</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/c语言/" style="font-size: 15px;">c语言</a> <a href="/tags/kong/" style="font-size: 15px;">kong</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/php源码/" style="font-size: 15px;">php源码</a> <a href="/tags/pear/" style="font-size: 15px;">pear</a> <a href="/tags/折腾/" style="font-size: 15px;">折腾</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/composer/" style="font-size: 15px;">composer</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/15/数据库-索引使用优化/">数据库-索引的使用优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/12/http各个状态码含义/">http各个状态码含义</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/12/C语言多维数组传参问题/">C语言多维数组传参问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/11/算法-螺旋矩阵/">算法-螺旋矩阵</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/算法-几种排序算法的实现/">算法-几种排序算法的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/算法-全排列-46/">算法-全排列-46</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/数据库-explain/">数据库-explain</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/算法-最接近的三数之和/">算法-最接近的三数之和-16</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/算法-盛水最多的容器/">算法-盛水最多的容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/算法-三数之和/">算法-三数之和</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://fivezh.github.io/archives/" title="武爷" target="_blank">武爷</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Maxie'blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>