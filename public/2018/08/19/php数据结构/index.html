<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> php数据结构 · Maxie'blog</title><meta name="description" content="php数据结构 - MaxieLj"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Maxie'blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/MaxieLj" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">php数据结构</h1><div class="post-info">Aug 19, 2018</div><div class="post-content"><p><code>[TOC]</code></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>php是如何统一实现各种变量类型的? 这和php变量类型的实现是密不可分的。<br>一个变量主要有三个要素:<code>变量名``变量类型``变量值</code>,他们在php变量类型实现中主要对应 zval zend_value 和<br>zend的各种数据类型。<br>php中用$去声明一个变量,在声明的时候可以进行初始化,当然也可以不声明直接使用。一般来说,一个变量的定义包含<br>两步:变量定义和变量初始化,在php中只定义不初始化是可以的。</p>
<h2 id="变量结构体"><a href="#变量结构体" class="headerlink" title="变量结构体"></a>变量结构体</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// php zval结构</span></div><div class="line"><span class="keyword">struct</span> _zval_struct &#123;</div><div class="line">	zend_value        value; 指向具体的value			<span class="comment">/* value */</span></div><div class="line">	<span class="keyword">union</span> &#123;</div><div class="line">		<span class="keyword">struct</span> &#123;</div><div class="line">			ZEND_ENDIAN_LOHI_4(</div><div class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></div><div class="line">				zend_uchar    type_flags,</div><div class="line">				zend_uchar    const_flags,</div><div class="line">				zend_uchar    reserved)	    <span class="comment">/* call info for EX(This) */</span></div><div class="line">		&#125; v;</div><div class="line">		<span class="keyword">uint32_t</span> type_info;</div><div class="line">	&#125; u1;</div><div class="line">	<span class="keyword">union</span> &#123;</div><div class="line">		<span class="keyword">uint32_t</span>     var_flags;</div><div class="line">		<span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></div><div class="line">		<span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* literal cache slot */</span></div><div class="line">		<span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></div><div class="line">		<span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></div><div class="line">		<span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></div><div class="line">		<span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></div><div class="line">	&#125; u2;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h2><p>其中type 表示当前变量的类型,例如string array int等,以下为php中全部变量类型。<br>其中type 是一个无符号类型的char,他的定义是这样的<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> zend_uchar;</div></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _zend_value &#123;</div><div class="line">    	zend_long         lval;				<span class="comment">/* long value */</span></div><div class="line">    	<span class="keyword">double</span>            dval;				<span class="comment">/* double value */</span></div><div class="line">    	zend_refcounted  *counted;</div><div class="line">    	zend_string      *str;</div><div class="line">    	zend_array       *arr;</div><div class="line">    	zend_object      *obj;</div><div class="line">    	zend_resource    *res;</div><div class="line">    	zend_reference   *ref;</div><div class="line">    	zend_ast_ref     *ast;</div><div class="line">    	zval             *zv;</div><div class="line">    	<span class="keyword">void</span>             *ptr;</div><div class="line">    	zend_class_entry *ce;</div><div class="line">    	zend_function    *func;</div><div class="line">    	<span class="keyword">struct</span> &#123;</div><div class="line">    		<span class="keyword">uint32_t</span> w1;</div><div class="line">    		<span class="keyword">uint32_t</span> w2;</div><div class="line">    	&#125; ww;</div><div class="line">    &#125; zend_value;</div></pre></td></tr></table></figure>
<ul>
<li>在这些类型里不存在boolean类型,因为在php7中已经将boolean拆分为true和false.直接保存在type中,也就是说<br>boolean没有_zend_value结构,直接通过type字段就可以确定boolean的值。</li>
<li>从上边的结构体可以看出来 <code>zend_long</code>、<code>double</code> 类型不是指针类型,也就是说整形和浮点型正能进行深拷贝,<br>并不能和其他说句类型一样进行 <code>引用计数</code>和<code>写时复制</code>。因为有<code>引用计数</code>和<code>写时复制</code>在变量赋值且不做修改时<br>才能大量节省内存。</li>
</ul>
<p>以string类型为例,它在php中的结构类型应该是这样的:</p>
<p><img src="/photo/img/php数据结构/php数据结构.png" alt="image"></p>
<p>_zend_string:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _zend_string &#123;</div><div class="line">	zend_refcounted_h gc;</div><div class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></div><div class="line">	<span class="keyword">size_t</span>            len;</div><div class="line">	<span class="keyword">char</span>              val[<span class="number">1</span>];          <span class="comment">/*字符串起始地址*/</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li>其中<code>gc</code> 字段表示这个结构体被引用的次数,垃圾回收的时候会用到。</li>
<li>h 字符串通过Times33计算出来的hashcode</li>
<li>len 字符串长度</li>
<li>val 字符串内容</li>
</ul>
<p>我们在这里都会有疑问,为什么存储字符串内容的时候没有使用char*类型,而用了一个数组类型来存储。zend_string<br>在申请内存的时候会会申请malloc(sizeof(zend_string)+字符串长度),且val[0]存的是字符串最后一个字符安“\0”</p>
<p>zend_string结构在内存中如下所示:</p>
<p><img src="/photo/img/php数据结构/zend_stirng内存中结构.png" alt="image"></p>
<p>当时也在char val[1]的地方疑惑了很久,再往上找了很多文章,其中<br>Nikita Popov(nikic，PHP 官方开发组成员，柏林科技大学的学生) 这样解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">如果你对 C 语言了解的不是很深入的话，可能会觉得 val 的定义有些奇怪：这个声明只有一个元素，但是显然我们想存储的字符串长度肯定大于一个字符的长度。这里其实使用的是结构体的一个『黑』方法：在声明数组时只定义一个元素，但是实际创建 zend_string 时再分配足够的内存来存储整个字符串。这样我们还是可以通过 val 访问完整的字符串。</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><ul>
<li><a href="https://nikic.github.io/2015/06/19/Internal-value-representation-in-PHP-7-part-2.html" target="_blank" rel="noopener">Internal value representation in PHP 7 - Part 2 </a></li>
<li><a href="https://0x1.im/blog/php/Internal-value-representation-in-PHP-7-part-2.html" target="_blank" rel="noopener">[译]变量在 PHP7 内部的实现（二）</a></li>
<li><a href="https://www.kancloud.cn/nickbai/php7/363268" target="_blank" rel="noopener">php内核分析——2.1 变量的内部实现</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/20/php数组实现/" class="prev">PREV</a><a href="/2018/08/12/php的&amp;符号/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">MaxieLj</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>