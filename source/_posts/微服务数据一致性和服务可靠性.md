---
title: 微服务数据一致性和服务可靠性
tags: 分布式,事务
grammar_cjkRuby: true
---


![enter description here][1]


  
  ## 存在问题
  我们的保证金服务现有结构是这个样子。
在 1、2、3、4、5、6 各个阶段都会存在超时和异常问题，当负载少时，我们还可以手动人工处理，但是当数据量大的时候，问题或多的令人发指，沉浸于洗数据，无法自拔。。
超时存在问题：
1.当1、2、3 步骤超时时，下游服务可以忽略，当做执行失败，重试。
2.当在环节4、5、6超时时，对于下游服务是也是执行失败，但是还可以重试么？


## 如何提高服务可靠性
对于上游服务，如何保证对下游提供可靠的服务。
 ### 补偿机制
 ![enter description here][2]
 在服务间的调用失败时，可以记录失败调用，如队列，消费重试。但是前提一定是接口幂等。
 但是这样并不能解决根本性问题，如果我们在调用保证金冻结服务时，失败此时我们冻结时报操作入队列，让队列异步消费，如果此时要解冻保证金，就会出现业务异常。
 
 **所以**补偿机制建议使用在 `不可避免的业务异常情况下使用`，我们应该尽可能的优化技术方案，来保证数据一致性，最后再采用补偿机制。
 ### 两段提交协议（2pc）
![enter description here][3]


preOperation 执行请求，在调用微服务前，执行预操作成功则表示此次操作可行。
如果commit失败该如何处理？重新preOperetion嘛？如果接口幂等是否可以重复，commit？如何保证避免重复提交？
在preOperation时，返回唯一操作ID，业务逻辑每个操作对应一个操作ID，commit失败就重试，当然前提是我们的上有服务接口幂等。

![enter description here][4]
1. 大量同步RPC依赖，如何保证自身服务可靠性？
 	服务之间在调用的时候，会存在大量异常、超时。我该如何处理，认为这次是失败的？还是成功的？如果依赖的服务返回成功，才算成功的话，我改如何保证服务可靠性，该如何对我的下游服务提供可靠的服务。
 2. 调用依赖服务失败，如何降级处理？
	 在服务调用失败的时候，我的上游出错了，我该如何降级处理，我该重试？还是直接跳过，跳过后是否会造成微服务之间数据一致性问题。如果重试是否会造成重复提交，接口是否幂等？
3.是否还欠缺回滚机制？ 


  [1]: ./images/%E4%BF%9D%E8%AF%81%E9%87%91%E6%9C%8D%E5%8A%A1-2-2.png "保证金服务-2-2.png"
  [2]: ./images/%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6.png "补偿机制.png"
  [3]: ./images/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6_2.png "未命名文件.png"
  [4]: ./images/%E8%BD%A6%E5%95%86%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%B4%A2%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7.png "车商微服务和财务数据一致性.png"